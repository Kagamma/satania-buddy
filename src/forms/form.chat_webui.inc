const WEBUI_CHATICON =
'<?xml version="1.0" encoding="iso-8859-1"?>'+
'<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->'+
'<svg height="800px" width="800px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"'+
'	 viewBox="0 0 512 512" xml:space="preserve">'+
'<path style="fill:#EAA0E3;" d="M346.501,149.761c0,8.366-1.232,16.528-3.584,24.408c-16.019,53.846-83.997,94.296-165.428,94.296'+
'	c-13.001,0-25.651-1.029-37.804-2.985c-5.506-0.882-10.909-1.956-16.189-3.199c-32.683,34.526-84.494,45.752-84.494,45.752'+
'	c20.349-20.349,29.992-46.227,34.514-64.688c-39.579-21.717-65.038-55.565-65.038-93.584c0-65.558,75.665-118.704,169.011-118.704'+
'	S346.501,84.203,346.501,149.761z"/>'+
'<path style="fill:#D57CD4;" d="M342.918,174.169c-16.019,53.846-83.997,94.296-165.428,94.296c-13.001,0-25.651-1.029-37.804-2.985'+
'	c16.019-53.846,84.008-94.296,165.428-94.296C318.114,171.185,330.765,172.213,342.918,174.169z"/>'+
'<path style="fill:#F4C063;" d="M334.51,203.964c93.343,0,169.011,53.145,169.011,118.704c0,38.02-25.455,71.863-65.043,93.589'+
'	c4.529,18.451,14.17,44.333,34.519,64.682c0,0-51.812-11.227-84.493-45.756c-16.955,4.012-35.112,6.188-53.994,6.188'+
'	c-93.343,0-169.011-53.145-169.011-118.704S241.168,203.964,334.51,203.964z"/>'+
'<path style="fill:#EC589B;" d="M334.51,300.998c0-21.354,14.702-38.665,32.839-38.665c22.671,0,41.049,21.638,41.049,48.33'+
'	c0,33.365-39.538,65.984-73.888,83.545c-34.349-17.56-73.888-50.18-73.888-83.545c0-26.692,18.379-48.33,41.049-48.33'+
'	C319.808,262.333,334.51,279.643,334.51,300.998z"/>'+
'<path d="M448.35,420.375c40.546-24.194,63.65-59.509,63.65-97.708c0-34.548-18.86-66.821-53.108-90.875'+
'	c-3.831-2.691-9.12-1.767-11.812,2.065c-2.691,3.832-1.767,9.12,2.065,11.812c29.597,20.787,45.896,48.131,45.896,76.997'+
'	c0,33.604-22.104,65.007-60.643,86.155c-3.366,1.847-5.07,5.726-4.155,9.454c3.197,13.025,8.895,29.825,18.976,46.078'+
'	c-16.689-6.68-38.306-17.83-54.557-35.002c-2.078-2.195-5.17-3.12-8.11-2.423c-16.715,3.956-34.224,5.96-52.042,5.96'+
'	c-88.518,0-160.532-49.446-160.532-110.225S245.993,212.44,334.511,212.44c32.62,0,64.039,6.728,90.861,19.454'+
'	c4.229,2.007,9.288,0.206,11.295-4.026c2.008-4.23,0.206-9.287-4.026-11.295c-26.692-12.665-57.478-19.831-89.513-20.926'+
'	c7.782-14.537,11.851-30.156,11.851-45.886c0-34.548-18.86-66.821-53.107-90.875c-33.335-23.413-77.509-36.307-124.383-36.307'+
'	S86.442,35.474,53.107,58.887C18.86,82.939,0,115.212,0,149.761c0,20.189,6.713,40.263,19.412,58.053'+
'	c2.72,3.812,8.015,4.695,11.826,1.975c3.812-2.72,4.695-8.015,1.975-11.826c-10.786-15.112-16.256-31.329-16.256-48.202'+
'	c0-60.777,72.015-110.225,160.532-110.225s160.532,49.446,160.532,110.225c0,16.078-4.954,31.528-14.718,45.98'+
'	c-42.672,1.886-82.511,14.513-113.176,36.052c-12.046,8.46-22.178,17.94-30.266,28.176c-0.79,0.009-1.582,0.018-2.372,0.018'+
'	c-17.786,0-35.298-2.004-52.046-5.957c-2.942-0.695-6.028,0.228-8.105,2.424c-16.253,17.17-37.87,28.319-54.556,34.997'+
'	c10.084-16.259,15.78-33.064,18.97-46.087c0.913-3.727-0.791-7.604-4.157-9.45c-11.165-6.126-21.117-13.247-29.578-21.165'+
'	c-3.419-3.2-8.785-3.023-11.985,0.398c-3.199,3.419-3.022,8.785,0.398,11.985c7.993,7.481,17.127,14.302,27.218,20.334'+
'	c-4.759,16.551-13.761,37.693-30.641,54.574c-2.66,2.66-3.249,6.754-1.448,10.056c1.507,2.763,4.388,4.419,7.442,4.419'+
'	c0.595,0,1.197-0.063,1.798-0.192c2.147-0.466,51.359-11.435,85.433-44.732c13.826,2.963,28.092,4.688,42.56,5.188'+
'	c-7.727,14.419-11.771,29.911-11.771,45.892c0,34.548,18.861,66.821,53.108,90.875c33.336,23.413,77.51,36.307,124.382,36.307'+
'	c17.477,0,34.696-1.801,51.262-5.36c34.071,33.296,83.284,44.27,85.43,44.735c0.6,0.13,1.202,0.192,1.797,0.192'+
'	c3.055,0,5.934-1.655,7.442-4.419c1.801-3.302,1.212-7.396-1.448-10.056C462.126,458.076,453.118,436.93,448.35,420.375z"/>'+
'<path d="M334.51,272.417c-7.556-11.276-19.466-18.563-32.839-18.563c-27.31,0-49.528,25.484-49.528,56.809'+
'	c0,37.613,42.291,72.58,78.507,91.094c1.212,0.62,2.536,0.929,3.86,0.929c1.324,0,2.648-0.31,3.86-0.929'+
'	c36.216-18.514,78.507-53.481,78.507-91.094c0-31.324-22.218-56.809-49.528-56.809C353.976,253.854,342.066,261.142,334.51,272.417z'+
'	 M399.919,310.664c0,19.649-20.263,49.831-65.409,73.977c-45.146-24.147-65.409-54.328-65.409-73.977'+
'	c0-21.975,14.611-39.852,32.57-39.852c13.432,0,24.36,13.541,24.36,30.186c0,4.683,3.796,8.479,8.479,8.479'+
'	c4.683,0,8.479-3.796,8.479-8.479c0-16.645,10.929-30.186,24.36-30.186C385.308,270.812,399.919,288.69,399.919,310.664z"/>'+
'</svg>';

type
  TWebUIToNativeUIProc = procedure(S: String);

  // Use it when we want to update native ui from webui
  TWebUIToNativeUIThread = class(TThread)
  protected
    FProc: TWebUIToNativeUIProc;
    FS: String;
    procedure Update;
  public
    constructor Create(Proc: TWebUIToNativeUIProc; S: String);
    destructor Destroy; override;
    procedure Execute; override;
  end;

var
  WebUIHandle: QWord;
        
procedure TWebUIToNativeUIThread.Update;
begin
  FProc(FS);
end;

constructor TWebUIToNativeUIThread.Create(Proc: TWebUIToNativeUIProc; S: String);
begin
  FS := S;
  FProc := Proc;
  FreeOnTerminate := True;
  inherited Create(True);
end;

destructor TWebUIToNativeUIThread.Destroy;
begin
  inherited;
end;

procedure TWebUIToNativeUIThread.Execute;
begin
  Synchronize(@Update);
  Terminate;
end;

// -----

procedure WebUI_CharacterSkinGet(E: PWebUIEvent);
begin
  webui_return_string(E, PChar(Save.Settings.Skin));
end;

procedure WebUI_CharacterNameGet(E: PWebUIEvent);
begin
  webui_return_string(E, PChar(Satania.Name));
end;

procedure WebUI_ChatHistoryGet(E: PWebUIEvent);
begin
  webui_return_string(E, PChar(FormChat.ChatHistory.ToJSONString(0)));
end;

procedure WebUI_ChatHistoryGetPlainText(E: PWebUIEvent);
begin
  webui_return_string(E, PChar(FormChat.ChatHistory.ToEdit));
end;

procedure WebUI_ChatIsStreaming(E: PWebUIEvent);
begin
  webui_return_bool(E, FormChat.RichText.IsStreaming);
end;

procedure WebUI_ChatSendProc(S: String);
begin
  FormChat.EditChat.Lines.Text := S;
  FormChat.Send;
end;
procedure WebUI_ChatSend(E: PWebUIEvent);
var
  Thread: TWebUIToNativeUIThread;
begin
  Thread := TWebUIToNativeUIThread.Create(@WebUI_ChatSendProc, webui_get_string(E));
  Thread.Start;
  WaitForThreadTerminate(Thread.ThreadID, 5000);
end;

procedure WebUI_ChatStopGenerating(E: PWebUIEvent);
begin
  FormChat.StopGenerating;
end;

procedure WebUI_ChatHistoryClear(E: PWebUIEvent);
begin
  FormChat.ClearHistory;
end;

procedure WebUI_ChatHistorySavePlainText(E: PWebUIEvent);
begin
  FormChat.SaveHistory(webui_get_string(E));
end;

procedure WebUI_ChatServiceSetProc(S: String);
begin
  FormChat.ComboBoxService.ItemIndex := StrToInt(S);
  FormChat.ComboBoxServiceChange(nil);
end;
procedure WebUI_ChatServiceSet(E: PWebUIEvent);
var
  Thread: TWebUIToNativeUIThread;
begin
  Thread := TWebUIToNativeUIThread.Create(@WebUI_ChatServiceSetProc, webui_get_string(E));
  Thread.Start;
  WaitForThreadTerminate(Thread.ThreadID, 5000);
end;

procedure WebUI_ChatServiceGet(E: PWebUIEvent);
begin
  webui_return_string(E, PChar(IntToStr(FormChat.ComboBoxService.ItemIndex)));
end;

procedure WebUI_ChatServiceGetList(E: PWebUIEvent);
begin
  webui_return_string(E, PChar(FormChat.LoadServiceList));
end;
       
procedure WebUI_ChatServiceEditProc(S: String);
begin
  FormChat.ButtonOpenServiceClick(nil);
end;
procedure WebUI_ChatServiceEdit(E: PWebUIEvent);
var
  Thread: TWebUIToNativeUIThread;
begin
  Thread := TWebUIToNativeUIThread.Create(@WebUI_ChatServiceEditProc, '');
  Thread.Start;
  WaitForThreadTerminate(Thread.ThreadID, 5000);
end;

procedure WebUI_ShowWebUI;
var
  RootPath,
  AvatarPath: String;
begin
  if WebUIHandle <> 0 then
    webui_close(WebUIHandle);
  WebUIHandle := webui_new_window;
  // Try to set root at user config dir if exists
  RootPath := GetOSLocalDir + 'webui';
  if not DirectoryExists(RootPath) then
    RootPath := 'data/webui';
  webui_set_root_folder(WebUIHandle, PChar(RootPath));
  // Prepare avatar
  AvatarPath := GetOSLocalDir + 'sprites/' + Save.Settings.Skin + '/avatar.png';
  if not FileExists(AvatarPath) then
    AvatarPath := 'data/sprites/' + Save.Settings.Skin + '/avatar.png';
  if FileExists(RootPath + '/chat/avatar_1.png') then
    DeleteFile(RootPath + '/chat/avatar_1.png');
  if FileExists(AvatarPath) then
  begin
    CopyFile(AvatarPath, RootPath + '/chat/avatar_1.png');
  end;
  //
  webui_set_port(WebUIHandle, Save.Settings.ChatWebUIPort);
  webui_bind(WebUIHandle, 'chat_history_get', @WebUI_ChatHistoryGet);
  webui_bind(WebUIHandle, 'chat_history_plaintext_get', @WebUI_ChatHistoryGetPlainText);
  webui_bind(WebUIHandle, 'chat_history_clear', @WebUI_ChatHistoryClear);
  webui_bind(WebUIHandle, 'chat_history_plaintext_save', @WebUI_ChatHistorySavePlainText);
  webui_bind(WebUIHandle, 'chat_is_streaming', @WebUI_ChatIsStreaming);
  webui_bind(WebUIHandle, 'chat_send', @WebUI_ChatSend);
  webui_bind(WebUIHandle, 'chat_stop_generating', @WebUI_ChatStopGenerating);
  webui_bind(WebUIHandle, 'chat_service_get', @WebUI_ChatServiceGet);
  webui_bind(WebUIHandle, 'chat_service_set', @WebUI_ChatServiceSet);
  webui_bind(WebUIHandle, 'chat_service_list_get', @WebUI_ChatServiceGetList);
  webui_bind(WebUIHandle, 'chat_service_edit', @WebUI_ChatServiceEdit);
  webui_bind(WebUIHandle, 'character_skin_get', @WebUI_CharacterSkinGet);
  webui_bind(WebUIHandle, 'character_name_get', @WebUI_CharacterNameGet);
  webui_set_icon(WebUIHandle, WEBUI_CHATICON, 'image/svg+xml');
  webui_show(WebUIHandle, 'chat/index.html');
end;
